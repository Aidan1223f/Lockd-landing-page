<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="/lockd.ico" />
  <title>Complete Your Setup - Lockd</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .logo {
      font-size: 32px;
      font-weight: 800;
      color: #7634D7;
      text-align: center;
      margin-bottom: 10px;
    }

    h1 {
      font-size: 24px;
      color: #1a1a1a;
      margin-bottom: 8px;
      text-align: center;
    }

    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .info-box {
      background: #f7f7f7;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .info-box p {
      color: #333;
      font-size: 14px;
      line-height: 1.6;
    }

    .info-box strong {
      color: #7634D7;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 16px;
      transition: border-color 0.3s;
      background: white;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="tel"]:focus,
    select:focus {
      outline: none;
      border-color: #7634D7;
    }

    .dob-group {
      display: grid;
      grid-template-columns: 2fr 1fr 1.5fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .address-line-2 {
      margin-bottom: 16px;
    }

    .section-divider {
      margin: 32px 0 24px;
      border-top: 1px solid #e0e0e0;
      padding-top: 24px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
    }

    #card-element {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    #card-errors {
      color: #ef4444;
      font-size: 14px;
      margin-bottom: 16px;
      min-height: 20px;
    }

    button {
      width: 100%;
      padding: 16px;
      background: #7634D7;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover:not(:disabled) {
      background: #5e2ba8;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .success {
      text-align: center;
    }

    .success-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .success h2 {
      color: #10b981;
      margin-bottom: 12px;
    }

    .success p {
      color: #666;
      margin-bottom: 24px;
    }

    .download-link {
      display: inline-block;
      padding: 12px 24px;
      background: #7634D7;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
    }

    .error {
      background: #fee2e2;
      border: 2px solid #ef4444;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #7634D7;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">Lockd</div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading invite...</p>
    </div>

    <!-- Error State -->
    <div id="error-state" style="display: none;">
      <h1>Invalid Invite</h1>
      <div class="error" id="error-message"></div>
    </div>

    <!-- Form State -->
    <div id="form-state" style="display: none;">
      <h1>You've Been Invited!</h1>
      <p class="subtitle">Complete your setup to start receiving instant payments to your debit card</p>

      <div class="info-box">
        <p><strong id="recipient-name"></strong>, you've been invited to receive accountability payments.</p>
      </div>

      <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 4px; margin-bottom: 20px; font-size: 13px;">
        <strong style="color: #f59e0b;">üîí Why we collect this information:</strong>
        <ul style="margin: 8px 0 0 20px; color: #78350f;">
          <li>Federal law requires identity verification for payment processing</li>
          <li>Your information is encrypted and securely processed by Stripe</li>
          <li>We never store your full SSN or card details</li>
        </ul>
      </div>

      <form id="payment-form">
        <label for="name">Full Name *</label>
        <input type="text" id="name" required>

        <label for="email">Email *</label>
        <input type="email" id="email" required>

        <!-- Identity Verification Section -->
        <div class="section-divider">
          <div class="section-title">Identity Verification</div>
          
          <label for="phone">Phone Number *</label>
          <input type="tel" id="phone" placeholder="+1 (555) 123-4567" required>

          <label for="ssn-last-4">SSN Last 4 Digits</label>
          <input type="text" id="ssn-last-4" maxlength="4" pattern="[0-9]{4}" placeholder="1234" required>

          <label>Date of Birth</label>
          <div class="dob-group">
            <select id="dob-month" required>
              <option value="">Month</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
            <select id="dob-day" required>
              <option value="">Day</option>
            </select>
            <select id="dob-year" required>
              <option value="">Year</option>
            </select>
          </div>
        </div>

        <!-- Address Section -->
        <div class="section-divider">
          <div class="section-title">Address</div>
          
          <label for="address-line-1">Street Address</label>
          <input type="text" id="address-line-1" required>

          <label for="address-line-2">Apartment, suite, etc. (Optional)</label>
          <input type="text" id="address-line-2" class="address-line-2">

          <label for="city">City</label>
          <input type="text" id="city" required>

          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px;">
            <div>
              <label for="state">State</label>
              <select id="state" required>
                <option value="">Select State</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
              </select>
            </div>
            <div>
              <label for="zip">ZIP Code</label>
              <input type="text" id="zip" maxlength="10" pattern="[0-9]{5}(-[0-9]{4})?" placeholder="12345" required>
            </div>
          </div>
        </div>

        <!-- Debit Card Section -->
        <div class="section-divider">
          <div class="section-title">Debit Card Information</div>
          <label>Card Details</label>
          <div id="card-element">
            <!-- Stripe Elements will create form elements here -->
          </div>
          <div id="card-errors" role="alert"></div>
        </div>

        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; margin: 20px 0; font-size: 12px; color: #6b7280;">
          <p style="margin-bottom: 12px;">By clicking "Complete Setup", you agree to:</p>
          <ul style="margin: 0 0 12px 20px; line-height: 1.8;">
            <li>Lockd's <a href="/terms" target="_blank" style="color: #7634D7; text-decoration: underline;">Terms of Service</a></li>
            <li>Lockd's <a href="/privacy" target="_blank" style="color: #7634D7; text-decoration: underline;">Privacy Policy</a></li>
            <li>Stripe's <a href="https://stripe.com/connect-account/legal" target="_blank" style="color: #7634D7; text-decoration: underline;">Connected Account Agreement</a></li>
          </ul>
          <p style="margin: 0; font-size: 11px; color: #9ca3af;">
            <strong>Payment fees:</strong> A processing fee of ~$0.60 per transaction will be added to charges.
            Payouts arrive in 2-3 business days at no cost.
          </p>
        </div>

        <button type="submit" id="submit-button">
          Complete Setup
        </button>
      </form>
    </div>

    <!-- Success State -->
    <div id="success-state" style="display: none;">
      <div class="success">
        <div class="success-icon">‚úÖ</div>
        <h2>All Set!</h2>
        <p id="success-message"></p>
        <a href="https://getlockd.app" class="download-link">Go to Lockd</a>
      </div>
    </div>

    <!-- Trust Badges Footer -->
    <div style="text-align: center; margin-top: 20px; padding: 16px; font-size: 12px; color: #9ca3af;">
      <div style="margin-bottom: 12px;">
        <span style="margin: 0 12px;">üîí Bank-level encryption</span>
        <span style="margin: 0 12px;">‚úì PCI DSS compliant</span>
        <span style="margin: 0 12px;">üõ°Ô∏è Powered by Stripe</span>
      </div>
      <p style="margin: 8px 0 0 0; font-size: 11px;">
        Your data is encrypted and processed securely. We never see or store your full card details.
      </p>
      <p style="margin: 8px 0 0 0; font-size: 11px;">
        <a href="mailto:support@getlockd.app" style="color: #7634D7; text-decoration: underline;">Need help?</a> ‚Ä¢
        <a href="/privacy" style="color: #7634D7; text-decoration: underline;">Privacy</a> ‚Ä¢
        <a href="/terms" style="color: #7634D7; text-decoration: underline;">Terms</a>
      </p>
    </div>
  </div>

  <script>
    // Configuration - UPDATE THESE VALUES
    const SUPABASE_URL = 'https://wlpwfprmkoqjbztxuogr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndscHdmcHJta29xamJ6dHh1b2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjI5MzAsImV4cCI6MjA3MDY5ODkzMH0.Hh9cDSxTPCN3rB2ItoHKBDIBaGO2yyC-DQ7WVmvsivM';
    const STRIPE_PUBLISHABLE_KEY = 'pk_test_51SMe4jC89gv3wtwgJXJ2wzEz12zF3A7X62SOPns1c1AAvMf2Y1EJQufjMhGqif8Dw7SwaLJQSIV0sODlzbGhnZnj00um9lsG8M';

    // Development/Test Mode - Set to true to use test token
    const USE_TEST_TOKEN = false; // Change to true for testing
    const TEST_TOKEN = 'test-token-123'; // Replace with your actual test token from database

    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    let token = urlParams.get('token');
    
    // If no token in query params, try to get from pathname
    if (!token || token.trim() === '') {
      const pathParts = window.location.pathname.split('/').filter(p => p && p !== 'setup.html');
      token = pathParts.length > 0 ? pathParts[pathParts.length - 1] : null;
    }
    
    // Clean up token
    if (token) {
      token = token.trim();
      // Remove any file extension if present
      if (token.endsWith('.html')) {
        token = null;
      }
    }

    // Use test token if enabled and no token found
    if ((!token || token.trim() === '') && USE_TEST_TOKEN) {
      token = TEST_TOKEN;
      console.log('Using test token for development:', token);
    }

    // Initialize Stripe with publishable key
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
    const elements = stripe.elements();
    const cardElement = elements.create('card', {
      style: {
        base: {
          fontSize: '16px',
          color: '#333',
          '::placeholder': {
            color: '#aaa',
          },
        },
      },
    });

    let inviteData = null;

    // Initialize date of birth dropdowns
    function initializeDOBDropdowns() {
      const daySelect = document.getElementById('dob-day');
      const yearSelect = document.getElementById('dob-year');
      
      // Populate days (1-31)
      for (let i = 1; i <= 31; i++) {
        const option = document.createElement('option');
        option.value = i.toString().padStart(2, '0');
        option.textContent = i;
        daySelect.appendChild(option);
      }
      
      // Populate years (1920 to current year, descending)
      const currentYear = new Date().getFullYear();
      for (let i = currentYear; i >= 1920; i--) {
        const option = document.createElement('option');
        option.value = i.toString();
        option.textContent = i;
        yearSelect.appendChild(option);
      }
      
      // Handle month change to adjust days for February/leap years
      document.getElementById('dob-month').addEventListener('change', updateDaysInMonth);
      document.getElementById('dob-year').addEventListener('change', updateDaysInMonth);
    }

    function updateDaysInMonth() {
      const month = document.getElementById('dob-month').value;
      const year = document.getElementById('dob-year').value;
      const daySelect = document.getElementById('dob-day');
      const selectedDay = daySelect.value;
      
      if (!month || !year) return;
      
      // Calculate days in the selected month
      const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
      const currentDays = daySelect.options.length - 1; // -1 for the "Day" placeholder
      
      // Adjust if necessary
      if (currentDays !== daysInMonth) {
        // Remove all but the first option
        while (daySelect.options.length > 1) {
          daySelect.remove(1);
        }
        
        // Add days for the month
        for (let i = 1; i <= daysInMonth; i++) {
          const option = document.createElement('option');
          option.value = i.toString().padStart(2, '0');
          option.textContent = i;
          daySelect.appendChild(option);
        }
        
        // Restore selection if still valid
        if (selectedDay && parseInt(selectedDay) <= daysInMonth) {
          daySelect.value = selectedDay;
        }
      }
    }

    // Convert phone number to E.164 format (+1234567890)
    function formatToE164(phoneValue) {
      // Strip all non-digit characters
      let digits = phoneValue.replace(/\D/g, '');
      
      // Remove leading 1 if present (US country code)
      if (digits.startsWith('1') && digits.length === 11) {
        digits = digits.slice(1);
      }
      
      // Must be exactly 10 digits for US number
      if (digits.length !== 10) {
        return null;
      }
      
      // Return in E.164 format: +1 + 10 digits
      return `+1${digits}`;
    }

    // Validate E.164 format
    function validateE164(phoneValue) {
      // E.164 format: + followed by country code (1) and 10 digits
      const e164Pattern = /^\+1\d{10}$/;
      return e164Pattern.test(phoneValue);
    }

    // Phone number auto-formatting (for display only)
    function formatPhoneNumber(input) {
      // Get cursor position before formatting
      const cursorPosition = input.selectionStart;
      const oldValue = input.value;
      
      // Extract digits, but handle the case where "+1 (" is already in the value
      // We need to extract only the phone number digits (not the "1" from "+1")
      let rawValue = input.value;
      
      // If the value starts with "+1 (", extract only digits after that
      // Otherwise, extract all digits and remove leading 1 if it's a country code
      let digits = '';
      if (rawValue.startsWith('+1 (')) {
        // Extract only digits that come after "+1 ("
        digits = rawValue.replace(/\D/g, '').slice(1); // Remove the "1" from "+1"
      } else if (rawValue.startsWith('+1')) {
        // Handle E.164 format input (+15551234567)
        digits = rawValue.replace(/\D/g, '').slice(1); // Remove the "1" from "+1"
      } else {
        // Extract all digits
        let allDigits = rawValue.replace(/\D/g, '');
        // Remove leading 1 only if we have 11 digits (country code + 10 digit number)
        if (allDigits.length === 11 && allDigits.startsWith('1')) {
          digits = allDigits.slice(1);
        } else {
          digits = allDigits;
        }
      }
      
      // Limit to 10 digits (the actual phone number)
      digits = digits.slice(0, 10);
      
      // Format the phone number with +1 prefix for display
      let formatted = '';
      if (digits.length === 0) {
        formatted = '';
      } else if (digits.length <= 3) {
        formatted = `+1 (${digits}`;
      } else if (digits.length <= 6) {
        formatted = `+1 (${digits.slice(0, 3)}) ${digits.slice(3)}`;
      } else {
        formatted = `+1 (${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
      }
      
      // Only update if the value actually changed
      if (input.value !== formatted) {
        input.value = formatted;
        
        // Calculate new cursor position
        // Count phone digits (excluding the "1" from "+1") before cursor in old value
        let phoneDigitsBeforeCursor = oldValue.slice(0, cursorPosition);
        if (phoneDigitsBeforeCursor.startsWith('+1 (')) {
          // Count digits after "+1 ("
          phoneDigitsBeforeCursor = phoneDigitsBeforeCursor.replace(/^\+1\s*\(/, '').replace(/\D/g, '');
        } else if (phoneDigitsBeforeCursor.startsWith('+1')) {
          // Handle E.164 format
          phoneDigitsBeforeCursor = phoneDigitsBeforeCursor.replace(/^\+1/, '').replace(/\D/g, '');
        } else {
          // Extract digits and remove leading 1 if it's country code
          let allDigits = phoneDigitsBeforeCursor.replace(/\D/g, '');
          if (allDigits.length === 11 && allDigits.startsWith('1')) {
            phoneDigitsBeforeCursor = allDigits.slice(1);
          } else {
            phoneDigitsBeforeCursor = allDigits;
          }
        }
        const digitCount = Math.min(phoneDigitsBeforeCursor.length, 10);
        
        // Find position in new formatted string (skip the "1" in "+1")
        let newPosition = formatted.length;
        let countedDigits = 0;
        // Start counting after "+1 ("
        for (let i = 4; i < formatted.length; i++) {
          if (/\d/.test(formatted[i])) {
            countedDigits++;
            if (countedDigits > digitCount) {
              newPosition = i;
              break;
            }
          }
        }
        
        // Set cursor position
        input.setSelectionRange(newPosition, newPosition);
      }
    }

    // SSN validation - only allow digits
    function validateSSN(input) {
      input.value = input.value.replace(/\D/g, '').slice(0, 4);
    }

    // Load invite data
    async function loadInvite() {
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/get-recipient-invite`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ token }),
        });

        const data = await response.json();

        if (!data.success) {
          showError(data.error || 'Invalid invite link');
          return;
        }

        if (data.alreadyCompleted) {
          showSuccess('This invite has already been completed!');
          return;
        }

        inviteData = data;
        showForm(data);
      } catch (error) {
        showError('Failed to load invite. Please try again.');
      }
    }

    function showForm(data) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('form-state').style.display = 'block';
      
      // Set recipient name in the info box (use placeholder if not available)
      const displayName = data.recipientName || 'there';
      document.getElementById('recipient-name').textContent = displayName;
      
      // Fill in name and email if available, otherwise leave empty for user to fill
      const nameInput = document.getElementById('name');
      const emailInput = document.getElementById('email');
      
      if (data.recipientName) {
        nameInput.value = data.recipientName;
      } else {
        nameInput.placeholder = 'Enter your full name';
      }
      
      if (data.email) {
        emailInput.value = data.email;
      } else {
        emailInput.placeholder = 'Enter your email address';
      }
      
      if (data.phone) {
        document.getElementById('phone').value = data.phone;
      }

      // Initialize DOB dropdowns
      initializeDOBDropdowns();

      // Add phone number formatting
      const phoneInput = document.getElementById('phone');
      phoneInput.addEventListener('input', (e) => formatPhoneNumber(e.target));
      
      // Allow paste and handle it properly (strips formatting, accepts E.164)
      phoneInput.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        // Convert to E.164 first, then format for display
        const e164Formatted = formatToE164(pastedText);
        if (e164Formatted) {
          // Extract digits from E.164 format for display formatting
          const digits = e164Formatted.replace(/\D/g, '').slice(1); // Remove +1, keep 10 digits
          phoneInput.value = digits;
          formatPhoneNumber(phoneInput);
        } else {
          // Try to extract digits and format
          const digits = pastedText.replace(/\D/g, '');
          if (digits.length >= 10) {
            const tenDigits = digits.slice(-10); // Take last 10 digits
            phoneInput.value = tenDigits;
            formatPhoneNumber(phoneInput);
          }
        }
      });

      // Add SSN validation
      const ssnInput = document.getElementById('ssn-last-4');
      ssnInput.addEventListener('input', (e) => validateSSN(e.target));

      // Mount card element
      cardElement.mount('#card-element');

      // Handle card errors
      cardElement.on('change', (event) => {
        const displayError = document.getElementById('card-errors');
        displayError.textContent = event.error ? event.error.message : '';
      });
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-state').style.display = 'block';
      document.getElementById('error-message').textContent = message;
    }

    function showSuccess(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('form-state').style.display = 'none';
      document.getElementById('success-state').style.display = 'block';
      document.getElementById('success-message').textContent = message || 'You can now receive payments!';
    }

    // Handle form submission
    document.getElementById('payment-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitButton = document.getElementById('submit-button');
      submitButton.disabled = true;
      submitButton.textContent = 'Processing...';

      try {
        // Create card token with currency specified (required for external accounts)
        const { token: cardToken, error } = await stripe.createToken(cardElement, {
          currency: 'usd'
        });

        if (error) {
          document.getElementById('card-errors').textContent = error.message;
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        // Get all form data
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const phoneInput = document.getElementById('phone').value;
        const ssnLast4 = document.getElementById('ssn-last-4').value;
        const dobMonth = document.getElementById('dob-month').value;
        const dobDay = document.getElementById('dob-day').value;
        const dobYear = document.getElementById('dob-year').value;
        const addressLine1 = document.getElementById('address-line-1').value.trim();
        const addressLine2 = document.getElementById('address-line-2').value.trim();
        const city = document.getElementById('city').value.trim();
        const state = document.getElementById('state').value;
        const zip = document.getElementById('zip').value.trim();

        // Validate required fields
        if (!token || token === '') {
          document.getElementById('card-errors').textContent = 'Invalid invite token. Please use the correct invite link.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        if (!cardToken || !cardToken.id) {
          document.getElementById('card-errors').textContent = 'Please enter a valid debit card.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        if (!ssnLast4 || ssnLast4.length !== 4) {
          document.getElementById('card-errors').textContent = 'Please enter a valid SSN last 4 digits.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        if (!dobYear || !dobMonth || !dobDay) {
          document.getElementById('card-errors').textContent = 'Please select your complete date of birth.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        // Validate and convert phone to E.164 format
        const formattedPhone = formatToE164(phoneInput);
        if (!formattedPhone) {
          document.getElementById('card-errors').textContent = 'Please enter a valid 10-digit phone number.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        // Validate E.164 format
        if (!validateE164(formattedPhone)) {
          document.getElementById('card-errors').textContent = 'Please enter a valid phone number in the correct format.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        if (!addressLine1 || addressLine1.trim() === '') {
          document.getElementById('card-errors').textContent = 'Please enter your street address.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        if (!city || city.trim() === '') {
          document.getElementById('card-errors').textContent = 'Please enter your city.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        if (!state || state === '') {
          document.getElementById('card-errors').textContent = 'Please select your state.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        if (!zip || zip.trim() === '') {
          document.getElementById('card-errors').textContent = 'Please enter your ZIP code.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        // Validate and format ZIP code (accept 5 digits or 5+4 format)
        const zipDigits = zip.replace(/\D/g, '');
        if (zipDigits.length < 5) {
          document.getElementById('card-errors').textContent = 'Please enter a valid ZIP code (at least 5 digits).';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }
        
        // Use first 5 digits for ZIP (ZIP+4 format will use first 5)
        const postalCode = zipDigits.length >= 5 ? zipDigits.substring(0, 5) : zipDigits;

        // Convert DOB fields to numbers
        const dobDayNum = parseInt(dobDay, 10);
        const dobMonthNum = parseInt(dobMonth, 10);
        const dobYearNum = parseInt(dobYear, 10);

        // Validate DOB numbers
        if (isNaN(dobDayNum) || isNaN(dobMonthNum) || isNaN(dobYearNum)) {
          document.getElementById('card-errors').textContent = 'Please select a valid date of birth.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        // Prepare request payload matching database expected format
        const trimmedName = name.trim();
        const trimmedEmail = email.trim();
        
        // Validate name and email are not empty after trimming
        if (!trimmedName || trimmedName === '') {
          document.getElementById('card-errors').textContent = 'Please enter your full name.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        if (!trimmedEmail || trimmedEmail === '' || !trimmedEmail.includes('@')) {
          document.getElementById('card-errors').textContent = 'Please enter a valid email address.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        const requestPayload = {
          token: token,
          debitCardToken: cardToken.id,
          email: trimmedEmail,
          fullName: trimmedName,
          phone: formattedPhone, // Already in E.164 format (+1234567890)
          ssnLast4: ssnLast4,
          dobDay: dobDayNum,
          dobMonth: dobMonthNum,
          dobYear: dobYearNum,
          addressLine1: addressLine1,
          addressLine2: addressLine2 || undefined, // Optional field
          city: city,
          state: state,
          postalCode: postalCode,
        };

        // Debug: Log the payload (remove in production if needed)
        console.log('Submitting form with payload:', { ...requestPayload, debitCardToken: '***' });

        // Submit to edge function with all data
        const response = await fetch(`${SUPABASE_URL}/functions/v1/complete-recipient-onboarding`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestPayload),
        });

        const responseText = await response.text();
        let data;
        
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          console.error('Failed to parse response:', responseText);
          document.getElementById('card-errors').textContent = 'Server returned an invalid response. Please try again.';
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        console.log('Server response:', data);

        if (!data.success) {
          const errorMessage = data.error || data.message || 'Setup failed. Please try again.';
          console.error('Server error:', errorMessage);
          document.getElementById('card-errors').textContent = errorMessage;
          submitButton.disabled = false;
          submitButton.textContent = 'Complete Setup';
          return;
        }

        showSuccess('You\'re all set! You\'ll receive instant payments to your debit card.');
      } catch (error) {
        console.error('Form submission error:', error);
        document.getElementById('card-errors').textContent = 'An unexpected error occurred. Please check the console for details and try again.';
        submitButton.disabled = false;
        submitButton.textContent = 'Complete Setup';
      }
    });

    // Load invite on page load
    loadInvite();
  </script>
</body>
</html>